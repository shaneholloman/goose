name: Build goose release candidate

on:
  pull_request:

jobs:
  bundle-desktop:
    if: startsWith(github.head_ref, 'release/')
    uses: ./.github/workflows/bundle-desktop.yml
    permissions:
      id-token: write
      contents: read

  comment-on-pr:
    needs: bundle-desktop
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Comment with download link
        uses: peter-evans/create-or-update-comment@e8674b075228eee787fea43ef493e45ece1004c9  # v5.0.0
        with:
          issue-number: ${{ github.event.number }}
          body: |
            ### macOS ARM64 Desktop App (Apple Silicon)

            [ðŸ“± Download macOS Desktop App (arm64, unsigned)](https://nightly.link/${{ github.repository }}/actions/runs/${{ github.run_id }}/Goose-darwin-arm64.zip)

            **Instructions:**
            
            The easiest way is to just run the following script:
            
            `./scripts/pre-release.sh`
            
            script which will download the latest release (or you can specify the release you need), does the
            unzip, xattr to get it out of quarantine and signs it.
            
            If you need to do this manually:
            
               * Download the file
               * Unzip
               * run `xattr -r -d com.apple.quarantine '/path/to/Goose.app'`
               * optionally run `codesign --force --deep --sign - --entitlements ui/desktop/entitlements.plist '/path/to/Goose.app'`
               * start the app
            
            The signing step is only needed if you do something that uses mac entitlements like speech to text
